# Carpentry System â€“ Development & Deployment Guide

Ten repozytorium zawiera szkielet systemu do zarzÄ…dzania warsztatem
stolarskim. Znajdziesz tutaj gotowy frontend (Next.js), schemat Prisma
oraz podstawowe narzÄ™dzia do Å‚Ä…czenia siÄ™ z bazÄ… danych PostgreSQL
(lokalnÄ… lub hostowanÄ… w chmurze). Kod zostaÅ‚ przygotowany tak, aby
moÅ¼na byÅ‚o natychmiast projektowaÄ‡ interfejs i rÃ³wnolegle pracowaÄ‡ nad
warstwÄ… backendowÄ….

## Co jest w pakiecie?

- **Dashboard Next.js** â€“ aplikacja w katalogu `web/` z gotowym ekranem
  startowym prezentujÄ…cym zlecenia, klientÃ³w i zespÃ³Å‚. Interfejs wymaga
  zalogowania i obsÅ‚uguje sesje HTTP-only.
- **Prisma schema** â€“ rozbudowany model domeny (`prisma/schema.prisma`)
  z tabelami `Workshop`, `Carpenter`, `Client`, `Order`, `OrderTask`,
  `OrderNote`, `User` i `Session` oraz enumami `OrderStatus`,
  `OrderPriority`, `TaskStatus`, `UserRole`.
- **API Next.js** â€“ endpointy `/api/health`, `/api/orders`,
  `/api/auth/login` oraz `/api/auth/logout` uÅ¼ywane do monitorowania stanu
  poÅ‚Ä…czenia, uwierzytelniania i pobierania listy zleceÅ„.
- **Skrypty pomocnicze** â€“ `npm run db:check` testuje poÅ‚Ä…czenie z bazÄ…,
  a `prisma/migrate.sh` uruchamia migracje w sposÃ³b przyjazny dla CI/CD.
- **Konfiguracja deploymentu** â€“ Dockerfile w `docker/` oraz (do
  uzupeÅ‚nienia) workflow GitHub Actions do Vercela i Google Cloud Run.

## Szybki start

1. Zainstaluj zaleÅ¼noÅ›ci (w katalogu gÅ‚Ã³wnym repozytorium):
   ```bash
   npm install
   npm install --prefix web
   ```
2. Skopiuj plik `.env.example` do `.env` i uzupeÅ‚nij zmienne
   Å›rodowiskowe: `DATABASE_URL`, `AUTH_SESSION_COOKIE_NAME`,
   `AUTH_SESSION_TTL_MINUTES` oraz `AUTH_SESSION_COOKIE_SECURE`.
   Adres powinien wskazywaÄ‡ na TwojÄ… bazÄ™ PostgreSQL (np.
   `postgresql://user:password@host:5432/dbname`).
   > ğŸªŸ UÅ¼ytkownicy Windows: ustaw `DATABASE_URL` w PowerShellu
   > poleceniem `setx DATABASE_URL "postgresql://..."` lub skorzystaj z
   > WSL, aby uniknÄ…Ä‡ problemÃ³w z migracjami.
3. Wygeneruj klienta Prisma i utwÃ³rz tabele (migracje sÄ… wersjonowane w katalogu `prisma/migrations/`):
   ```bash
   npx prisma generate
   npx prisma migrate deploy
   ```
   JeÅ›li musisz rÄ™cznie odtworzyÄ‡ schemat, uruchom skrypt z pliku `prisma/sql/20250926_init.sql` w swojej bazie.

   Skrypt pomija juÅ¼ istniejÄ…ce typy enum, indeksy i klucze obce, dziÄ™ki czemu moÅ¼na go bezpiecznie uruchamiaÄ‡ ponownie.

   Po tej zmianie tabele `User`/`Session` (oraz odpowiadajÄ…ce im `public.users`/`public.sessions`) majÄ… wÅ‚Ä…czonÄ… politykÄ™ RLS, ktÃ³ra dopuszcza jedynie rolÄ™ `service_role` Supabase. JeÅ›li chcesz, aby inne role (np. `authenticated`/`anon` lub dedykowane role aplikacji) mogÅ‚y czytaÄ‡ lub zapisywaÄ‡ dane logowania, dodaj wÅ‚asne polityki `CREATE POLICY` po wdroÅ¼eniu migracji.


4. UtwÃ³rz konto administratora (wymagane do logowania):
   ```bash
   npx ts-node scripts/create-admin.ts admin@example.com SuperTajneHaslo
   ```
   Polecenie tworzy (lub aktualizuje) uÅ¼ytkownika z rolÄ… `admin` i ustawia nowe hasÅ‚o.

5. Uruchom lokalnie dashboard (w katalogu `web/`):
   ```bash
   npm run dev
   ```
   Interfejs bÄ™dzie dostÄ™pny pod adresem `http://localhost:3000`.

Po wykonaniu migracji i utworzeniu kont uÅ¼ytkownikÃ³w interfejs wymaga
zalogowania. JeÅ›li baza nie ma jeszcze tabel, moduÅ‚ dashboardu nadal moÅ¼e
wyÅ›wietliÄ‡ dane przykÅ‚adowe (dla celÃ³w projektowych), ale endpointy API
zwracajÄ… komunikaty o brakujÄ…cych migracjach.

> ğŸ’¡ JeÅ›li klonujesz repozytorium po raz pierwszy na Windowsie,
> rozwaÅ¼ uruchomienie polecenia `git config core.autocrlf false`, aby
> uniknÄ…Ä‡ ponownej konwersji koÅ„cÃ³wek linii w plikach.

## Model danych

| Model       | Kluczowe pola                              | Opis                                                 |
|-------------|--------------------------------------------|------------------------------------------------------|
| `Workshop`  | `name`, `location`                         | Warsztat lub zespÃ³Å‚, do ktÃ³rego przypisani sÄ… stolarze. |
| `Carpenter` | `name`, `skills[]`, `workshopId`           | Informacje o stolarzach, ich umiejÄ™tnoÅ›ciach i powiÄ…zaniu z warsztatem. |
| `Client`    | `name`, `company`, `contact`               | Dane kontaktowe klientÃ³w oraz notatki.               |
| `Order`     | `reference`, `status`, `priority`, `budgetCents`, `dueDate` | ZamÃ³wienia wraz z priorytetem, terminami i przypisaniami. |
| `OrderTask` | `title`, `status`, `assigneeId`, `dueDate` | Zadania skÅ‚adajÄ…ce siÄ™ na zamÃ³wienie (checklista).   |
| `OrderNote` | `author`, `message`                        | Notatki wewnÄ™trzne do zlecenia.                      |
| `User`      | `email`, `passwordHash`, `roles[]`         | Konta uÅ¼ytkownikÃ³w z opcjonalnym powiÄ…zaniem z klientem/stolarzem. |
| `Session`   | `token`, `userId`, `expiresAt`             | Sesje HTTP-only, kasowane po wylogowaniu lub wygaÅ›niÄ™ciu. |

Enumy:

- `OrderStatus` â€“ `PENDING`, `IN_PROGRESS`, `READY_FOR_DELIVERY`,
  `COMPLETED`, `CANCELLED`
- `OrderPriority` â€“ `LOW`, `MEDIUM`, `HIGH`, `URGENT`
- `TaskStatus` â€“ `PENDING`, `IN_PROGRESS`, `COMPLETED`, `BLOCKED`
- `UserRole` â€“ `admin`, `carpenter`, `client`

## Endpointy API (Next.js)

| Endpoint        | Opis                                                         |
|-----------------|--------------------------------------------------------------|
| `GET /api/health` | Zwraca status poÅ‚Ä…czenia z bazÄ… (`ok`, `unreachable`, `error`). |
| `GET /api/orders` | Lista zleceÅ„ z relacjami. Wymaga aktywnej sesji; przy braku migracji zwraca komunikat o bÅ‚Ä™dzie. |
| `POST /api/auth/login` | Uwierzytelnienie uÅ¼ytkownika, zapis sesji i ustawienie ciasteczka HTTP-only. |
| `POST /api/auth/logout` | Usuwa sesjÄ™ i czyÅ›ci ciasteczko. |

Kolejne kroki to dodanie metod `POST/PUT/DELETE`, ktÃ³re pozwolÄ…
zarzÄ…dzaÄ‡ zleceniami z poziomu panelu.

## Testowanie poÅ‚Ä…czenia z bazÄ…

Skrypt `npm run db:check` (uruchamiany w katalogu gÅ‚Ã³wnym) wczytuje
zmienne z `.env`, Å‚Ä…czy siÄ™ z bazÄ… za pomocÄ… Prisma i wykonuje zapytanie
`SELECT NOW()`. JeÅ›li zobaczysz bÅ‚Ä…d poÅ‚Ä…czenia, upewnij siÄ™, Å¼e
`DATABASE_URL` jest ustawione poprawnie oraz Å¼e masz dostÄ™p sieciowy do
instancji.

## Uruchamianie migracji

```bash
export DATABASE_URL="postgresql://user:password@host:5432/db?sslmode=require"
bash prisma/migrate.sh
```

Skrypt wygeneruje klienta Prisma i zastosuje wszystkie oczekujÄ…ce
migracje. JeÅ›li TwÃ³j dostawca udostÄ™pnia PgBouncera lub inny pooler,
podÅ‚Ä…cz siÄ™ do wskazanego portu (najczÄ™Å›ciej 6543); w pozostaÅ‚ych
przypadkach uÅ¼yj standardowego portu 5432.

> ğŸ’¾ Potrzebujesz manualnie zainicjalizowaÄ‡ bazÄ™? Skorzystaj ze skryptu
> `prisma/sql/20250926_init.sql`, ktÃ³ry odtwarza aktualny schemat
> (generowany poleceniem `npx prisma migrate diff --from-empty --to-schema-datamodel prisma/schema.prisma --script`).

## Integracja z bazÄ… danych i Google Cloud SQL

### Hostowana baza PostgreSQL

Platformy takie jak Neon, Railway czy Render udostÄ™pniajÄ… connection
string, ktÃ³ry wystarczy wkleiÄ‡ do `.env`. PamiÄ™taj o ustawieniu zmiennej
`DATABASE_URL` rÃ³wnieÅ¼ w Å›rodowisku produkcyjnym (np. na Vercelu), aby
aplikacja mogÅ‚a poÅ‚Ä…czyÄ‡ siÄ™ z bazÄ…. Komenda `npm run db:check`
zweryfikuje, czy poÅ‚Ä…czenie dziaÅ‚a poprawnie.

### Migracja do Cloud SQL

Gdy projekt uroÅ›nie, zaplanuj migracjÄ™ do Google Cloud SQL w regionie
`europe-central2` (Warszawa). Masz dwa warianty poÅ‚Ä…czenia:

1. **Cloud SQL Auth Proxy** â€“ osobny proces uwierzytelniany przez IAM,
   zestawia szyfrowane poÅ‚Ä…czenie TLS. Wymaga wystawienia publicznego IP
   lub prywatnego Å‚Ä…cza VPC.
2. **Cloud SQL Node.js Connector** â€“ biblioteka doÅ‚Ä…czana do aplikacji,
   rÃ³wnieÅ¼ korzystajÄ…ca z IAM i TLS 1.3. Po zainicjalizowaniu funkcjÄ…
   `startLocalProxy()` moÅ¼esz przekierowaÄ‡ `DATABASE_URL` na gniazdo Unix.

PamiÄ™taj, Å¼e Vercel nie gwarantuje staÅ‚ych adresÃ³w IP â€“ uÅ¼yj proxy lub
konektora, aby uniknÄ…Ä‡ koniecznoÅ›ci biaÅ‚ych list IP.

## Docker i deployment

- `docker/Dockerfile` â€“ wieloetapowy build, ktÃ³ry najpierw instaluje
  zaleÅ¼noÅ›ci i buduje projekt, a nastÄ™pnie przygotowuje lekki obraz
  runtime z Node.js. Kontener domyÅ›lnie wystawia port 3000.
- Po zbudowaniu obrazu (`docker build -t meblomat .`) moÅ¼esz uruchomiÄ‡
  kontener lokalnie: `docker run -p 3000:3000 meblomat`.

Workflow GitHub Actions (`.github/workflows/`) pozostawiono pusty do
uzupeÅ‚nienia â€“ moÅ¼esz dodaÄ‡ automatyczne publikacje do Vercela i Cloud
Run, gdy projekt bÄ™dzie gotowy do wdroÅ¼eÅ„.

## Struktura repozytorium

```
.
â”œâ”€â”€ prisma/            # Schema, klient Prisma i skrypt migracyjny
â”œâ”€â”€ scripts/           # check-db.ts, create-admin.ts (narzÄ™dzia CLI)
â”œâ”€â”€ web/               # Aplikacja Next.js (dashboard)
â”‚   â”œâ”€â”€ src/app/       # Strony, endpointy API i style globalne
â”‚   â”œâ”€â”€ src/components # Komponenty UI (statusy, pipeline zleceÅ„)
â”‚   â”œâ”€â”€ src/lib/       # Dane przykÅ‚adowe, formatowanie, helpery Prisma
â”‚   â””â”€â”€ src/server/    # Logika Å‚Ä…czenia danych dla dashboardu
â”œâ”€â”€ docker/            # Dockerfile dla Cloud Run
â””â”€â”€ README.md          # Ten plik
```

## NastÄ™pne kroki

1. Zaimplementuj endpointy `POST`/`PATCH` dla zamÃ³wieÅ„ oraz notatek.
2. Rozbuduj obsÅ‚ugÄ™ rÃ³l (np. zrÃ³Å¼nicowane uprawnienia `admin`/`carpenter`/`client`).
3. Rozbuduj pipeline CI/CD i monitoruj logi po wdroÅ¼eniu na produkcjÄ™.

Powodzenia w dalszym rozwijaniu Meblomatu! JeÅ›li potrzebujesz kolejnych
funkcjonalnoÅ›ci, rozbuduj moduÅ‚y w katalogach `web/src/server` i
`web/src/app/api`.
